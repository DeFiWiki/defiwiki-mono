{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _asyncToGenerator = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar _classCallCheck = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function get() {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) {\n    if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  }\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.authenticate = exports.createLink = exports.normalizeAccountId = exports.isERC1271 = exports.isEthAddress = exports.EthereumAuthProvider = void 0;\n\nvar caip_1 = require(\"caip\");\n\nvar util_1 = require(\"./util\");\n\nvar uint8arrays = __importStar(require(\"uint8arrays\"));\n\nvar sha256 = __importStar(require(\"@stablelib/sha256\"));\n\nvar ADDRESS_TYPES = {\n  ethereumEOA: \"ethereum-eoa\",\n  erc1271: \"erc1271\"\n};\nvar CHAIN_NAMESPACE = \"eip155\";\n\nvar EthereumAuthProvider = /*#__PURE__*/function () {\n  function EthereumAuthProvider(provider, address) {\n    var opts = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};\n\n    _classCallCheck(this, EthereumAuthProvider);\n\n    this.provider = provider;\n    this.address = address;\n    this.opts = opts;\n    this.isAuthProvider = true;\n  }\n\n  _createClass(EthereumAuthProvider, [{\n    key: \"accountId\",\n    value: function () {\n      var _accountId = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var payload, chainIdHex, chainId;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                payload = util_1.encodeRpcMessage(\"eth_chainId\", []);\n                _context.next = 3;\n                return safeSend(payload, this.provider);\n\n              case 3:\n                chainIdHex = _context.sent;\n                chainId = parseInt(chainIdHex, 16);\n                return _context.abrupt(\"return\", new caip_1.AccountID({\n                  address: this.address,\n                  chainId: \"\".concat(CHAIN_NAMESPACE, \":\").concat(chainId)\n                }));\n\n              case 6:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function accountId() {\n        return _accountId.apply(this, arguments);\n      }\n\n      return accountId;\n    }()\n  }, {\n    key: \"authenticate\",\n    value: function () {\n      var _authenticate2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(message) {\n        var accountId;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return this.accountId();\n\n              case 2:\n                accountId = _context2.sent;\n                return _context2.abrupt(\"return\", _authenticate(message, accountId, this.provider));\n\n              case 4:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function authenticate(_x) {\n        return _authenticate2.apply(this, arguments);\n      }\n\n      return authenticate;\n    }()\n  }, {\n    key: \"createLink\",\n    value: function () {\n      var _createLink2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(did) {\n        var accountId;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return this.accountId();\n\n              case 2:\n                accountId = _context3.sent;\n                return _context3.abrupt(\"return\", _createLink(did, accountId, this.provider, this.opts));\n\n              case 4:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function createLink(_x2) {\n        return _createLink2.apply(this, arguments);\n      }\n\n      return createLink;\n    }()\n  }, {\n    key: \"withAddress\",\n    value: function withAddress(address) {\n      return new EthereumAuthProvider(this.provider, address);\n    }\n  }]);\n\n  return EthereumAuthProvider;\n}();\n\nexports.EthereumAuthProvider = EthereumAuthProvider;\n\nfunction isEthAddress(address) {\n  return /^0x[a-fA-F0-9]{40}$/.test(address);\n}\n\nexports.isEthAddress = isEthAddress;\n\nfunction getCode(_x3, _x4) {\n  return _getCode.apply(this, arguments);\n}\n\nfunction _getCode() {\n  _getCode = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(address, provider) {\n    var payload;\n    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            payload = util_1.encodeRpcMessage(\"eth_getCode\", [address, \"latest\"]);\n            return _context4.abrupt(\"return\", safeSend(payload, provider));\n\n          case 2:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n  return _getCode.apply(this, arguments);\n}\n\nfunction safeSend(_x5, _x6) {\n  return _safeSend.apply(this, arguments);\n}\n\nfunction _safeSend() {\n  _safeSend = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(data, provider) {\n    var send;\n    return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n      while (1) {\n        switch (_context5.prev = _context5.next) {\n          case 0:\n            send = (provider.sendAsync ? provider.sendAsync : provider.send).bind(provider);\n            return _context5.abrupt(\"return\", new Promise(function (resolve, reject) {\n              send(data, function (err, result) {\n                if (err) reject(err);else if (result.error) reject(result.error);else resolve(result.result);\n              });\n            }));\n\n          case 2:\n          case \"end\":\n            return _context5.stop();\n        }\n      }\n    }, _callee5);\n  }));\n  return _safeSend.apply(this, arguments);\n}\n\nfunction isERC1271(_x7, _x8) {\n  return _isERC.apply(this, arguments);\n}\n\nfunction _isERC() {\n  _isERC = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(account, provider) {\n    var bytecode;\n    return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            _context6.next = 2;\n            return getCode(account.address, provider).catch(function () {\n              return null;\n            });\n\n          case 2:\n            bytecode = _context6.sent;\n            return _context6.abrupt(\"return\", Boolean(bytecode && bytecode !== \"0x\" && bytecode !== \"0x0\" && bytecode !== \"0x00\"));\n\n          case 4:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  }));\n  return _isERC.apply(this, arguments);\n}\n\nexports.isERC1271 = isERC1271;\n\nfunction normalizeAccountId(account) {\n  account.address = account.address.toLowerCase();\n  return account;\n}\n\nexports.normalizeAccountId = normalizeAccountId;\n\nfunction utf8toHex(message) {\n  var bytes = uint8arrays.fromString(message);\n  var hex = uint8arrays.toString(bytes, \"base16\");\n  return \"0x\" + hex;\n}\n\nfunction createEthLink(_x9, _x10, _x11) {\n  return _createEthLink.apply(this, arguments);\n}\n\nfunction _createEthLink() {\n  _createEthLink = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(did, account, provider) {\n    var opts,\n        _util_1$getConsentMes,\n        message,\n        timestamp,\n        hexMessage,\n        payload,\n        signature,\n        proof,\n        _args7 = arguments;\n\n    return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n      while (1) {\n        switch (_context7.prev = _context7.next) {\n          case 0:\n            opts = _args7.length > 3 && _args7[3] !== undefined ? _args7[3] : {};\n            _util_1$getConsentMes = util_1.getConsentMessage(did, !opts.skipTimestamp), message = _util_1$getConsentMes.message, timestamp = _util_1$getConsentMes.timestamp;\n            hexMessage = utf8toHex(message);\n            payload = util_1.encodeRpcMessage(\"personal_sign\", [hexMessage, account.address]);\n            _context7.next = 6;\n            return safeSend(payload, provider);\n\n          case 6:\n            signature = _context7.sent;\n            proof = {\n              version: 2,\n              type: ADDRESS_TYPES.ethereumEOA,\n              message: message,\n              signature: signature,\n              account: account.toString()\n            };\n            if (!opts.skipTimestamp) proof.timestamp = timestamp;\n            return _context7.abrupt(\"return\", proof);\n\n          case 10:\n          case \"end\":\n            return _context7.stop();\n        }\n      }\n    }, _callee7);\n  }));\n  return _createEthLink.apply(this, arguments);\n}\n\nfunction validateChainId(_x12, _x13) {\n  return _validateChainId.apply(this, arguments);\n}\n\nfunction _validateChainId() {\n  _validateChainId = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8(account, provider) {\n    var payload, chainIdHex, chainId;\n    return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n      while (1) {\n        switch (_context8.prev = _context8.next) {\n          case 0:\n            payload = util_1.encodeRpcMessage(\"eth_chainId\", []);\n            _context8.next = 3;\n            return safeSend(payload, provider);\n\n          case 3:\n            chainIdHex = _context8.sent;\n            chainId = parseInt(chainIdHex, 16);\n\n            if (!(chainId !== parseInt(account.chainId.reference))) {\n              _context8.next = 7;\n              break;\n            }\n\n            throw new Error(\"ChainId in provider (\".concat(chainId, \") is different from AccountID (\").concat(account.chainId.reference, \")\"));\n\n          case 7:\n          case \"end\":\n            return _context8.stop();\n        }\n      }\n    }, _callee8);\n  }));\n  return _validateChainId.apply(this, arguments);\n}\n\nfunction createErc1271Link(_x14, _x15, _x16, _x17) {\n  return _createErc1271Link.apply(this, arguments);\n}\n\nfunction _createErc1271Link() {\n  _createErc1271Link = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee9(did, account, provider, opts) {\n    var ethLinkAccount, res;\n    return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n      while (1) {\n        switch (_context9.prev = _context9.next) {\n          case 0:\n            ethLinkAccount = (opts === null || opts === void 0 ? void 0 : opts.eoaSignAccount) || account;\n            _context9.next = 3;\n            return createEthLink(did, ethLinkAccount, provider, opts);\n\n          case 3:\n            res = _context9.sent;\n            _context9.next = 6;\n            return validateChainId(account, provider);\n\n          case 6:\n            return _context9.abrupt(\"return\", Object.assign(res, {\n              type: ADDRESS_TYPES.erc1271,\n              account: account.toString()\n            }));\n\n          case 7:\n          case \"end\":\n            return _context9.stop();\n        }\n      }\n    }, _callee9);\n  }));\n  return _createErc1271Link.apply(this, arguments);\n}\n\nfunction _createLink(_x18, _x19, _x20, _x21) {\n  return _createLink3.apply(this, arguments);\n}\n\nfunction _createLink3() {\n  _createLink3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee10(did, account, provider, opts) {\n    return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n      while (1) {\n        switch (_context10.prev = _context10.next) {\n          case 0:\n            account = normalizeAccountId(account);\n            _context10.next = 3;\n            return isERC1271(account, provider);\n\n          case 3:\n            if (!_context10.sent) {\n              _context10.next = 7;\n              break;\n            }\n\n            return _context10.abrupt(\"return\", createErc1271Link(did, account, provider, opts));\n\n          case 7:\n            return _context10.abrupt(\"return\", createEthLink(did, account, provider, opts));\n\n          case 8:\n          case \"end\":\n            return _context10.stop();\n        }\n      }\n    }, _callee10);\n  }));\n  return _createLink3.apply(this, arguments);\n}\n\nexports.createLink = _createLink;\n\nfunction _authenticate(_x22, _x23, _x24) {\n  return _authenticate3.apply(this, arguments);\n}\n\nfunction _authenticate3() {\n  _authenticate3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee11(message, account, provider) {\n    var hexMessage, payload, signature, signatureBytes, digest;\n    return _regeneratorRuntime.wrap(function _callee11$(_context11) {\n      while (1) {\n        switch (_context11.prev = _context11.next) {\n          case 0:\n            if (account) account = normalizeAccountId(account);\n\n            if (!provider.isAuthereum) {\n              _context11.next = 3;\n              break;\n            }\n\n            return _context11.abrupt(\"return\", provider.signMessageWithSigningKey(message));\n\n          case 3:\n            hexMessage = utf8toHex(message);\n            payload = util_1.encodeRpcMessage(\"personal_sign\", [hexMessage, account.address]);\n            _context11.next = 7;\n            return safeSend(payload, provider);\n\n          case 7:\n            signature = _context11.sent;\n            signatureBytes = uint8arrays.fromString(signature.slice(2));\n            digest = sha256.hash(signatureBytes);\n            return _context11.abrupt(\"return\", \"0x\".concat(uint8arrays.toString(digest, 'base16')));\n\n          case 11:\n          case \"end\":\n            return _context11.stop();\n        }\n      }\n    }, _callee11);\n  }));\n  return _authenticate3.apply(this, arguments);\n}\n\nexports.authenticate = _authenticate;","map":{"version":3,"sources":["../src/ethereum.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.authenticate = exports.createLink = exports.normalizeAccountId = exports.isERC1271 = exports.isEthAddress = exports.EthereumAuthProvider = void 0;\nconst caip_1 = require(\"caip\");\nconst util_1 = require(\"./util\");\nconst uint8arrays = __importStar(require(\"uint8arrays\"));\nconst sha256 = __importStar(require(\"@stablelib/sha256\"));\nconst ADDRESS_TYPES = {\n    ethereumEOA: \"ethereum-eoa\",\n    erc1271: \"erc1271\",\n};\nconst CHAIN_NAMESPACE = \"eip155\";\nclass EthereumAuthProvider {\n    constructor(provider, address, opts = {}) {\n        this.provider = provider;\n        this.address = address;\n        this.opts = opts;\n        this.isAuthProvider = true;\n    }\n    async accountId() {\n        const payload = util_1.encodeRpcMessage(\"eth_chainId\", []);\n        const chainIdHex = await safeSend(payload, this.provider);\n        const chainId = parseInt(chainIdHex, 16);\n        return new caip_1.AccountID({\n            address: this.address,\n            chainId: `${CHAIN_NAMESPACE}:${chainId}`,\n        });\n    }\n    async authenticate(message) {\n        const accountId = await this.accountId();\n        return authenticate(message, accountId, this.provider);\n    }\n    async createLink(did) {\n        const accountId = await this.accountId();\n        return createLink(did, accountId, this.provider, this.opts);\n    }\n    withAddress(address) {\n        return new EthereumAuthProvider(this.provider, address);\n    }\n}\nexports.EthereumAuthProvider = EthereumAuthProvider;\nfunction isEthAddress(address) {\n    return /^0x[a-fA-F0-9]{40}$/.test(address);\n}\nexports.isEthAddress = isEthAddress;\nasync function getCode(address, provider) {\n    const payload = util_1.encodeRpcMessage(\"eth_getCode\", [address, \"latest\"]);\n    return safeSend(payload, provider);\n}\nasync function safeSend(data, provider) {\n    const send = (provider.sendAsync ? provider.sendAsync : provider.send).bind(provider);\n    return new Promise((resolve, reject) => {\n        send(data, function (err, result) {\n            if (err)\n                reject(err);\n            else if (result.error)\n                reject(result.error);\n            else\n                resolve(result.result);\n        });\n    });\n}\nasync function isERC1271(account, provider) {\n    const bytecode = await getCode(account.address, provider).catch(() => null);\n    return Boolean(bytecode && bytecode !== \"0x\" && bytecode !== \"0x0\" && bytecode !== \"0x00\");\n}\nexports.isERC1271 = isERC1271;\nfunction normalizeAccountId(account) {\n    account.address = account.address.toLowerCase();\n    return account;\n}\nexports.normalizeAccountId = normalizeAccountId;\nfunction utf8toHex(message) {\n    const bytes = uint8arrays.fromString(message);\n    const hex = uint8arrays.toString(bytes, \"base16\");\n    return \"0x\" + hex;\n}\nasync function createEthLink(did, account, provider, opts = {}) {\n    const { message, timestamp } = util_1.getConsentMessage(did, !opts.skipTimestamp);\n    const hexMessage = utf8toHex(message);\n    const payload = util_1.encodeRpcMessage(\"personal_sign\", [\n        hexMessage,\n        account.address,\n    ]);\n    const signature = await safeSend(payload, provider);\n    const proof = {\n        version: 2,\n        type: ADDRESS_TYPES.ethereumEOA,\n        message,\n        signature,\n        account: account.toString(),\n    };\n    if (!opts.skipTimestamp)\n        proof.timestamp = timestamp;\n    return proof;\n}\nasync function validateChainId(account, provider) {\n    const payload = util_1.encodeRpcMessage(\"eth_chainId\", []);\n    const chainIdHex = await safeSend(payload, provider);\n    const chainId = parseInt(chainIdHex, 16);\n    if (chainId !== parseInt(account.chainId.reference)) {\n        throw new Error(`ChainId in provider (${chainId}) is different from AccountID (${account.chainId.reference})`);\n    }\n}\nasync function createErc1271Link(did, account, provider, opts) {\n    const ethLinkAccount = (opts === null || opts === void 0 ? void 0 : opts.eoaSignAccount) || account;\n    const res = await createEthLink(did, ethLinkAccount, provider, opts);\n    await validateChainId(account, provider);\n    return Object.assign(res, {\n        type: ADDRESS_TYPES.erc1271,\n        account: account.toString(),\n    });\n}\nasync function createLink(did, account, provider, opts) {\n    account = normalizeAccountId(account);\n    if (await isERC1271(account, provider)) {\n        return createErc1271Link(did, account, provider, opts);\n    }\n    else {\n        return createEthLink(did, account, provider, opts);\n    }\n}\nexports.createLink = createLink;\nasync function authenticate(message, account, provider) {\n    if (account)\n        account = normalizeAccountId(account);\n    if (provider.isAuthereum)\n        return provider.signMessageWithSigningKey(message);\n    const hexMessage = utf8toHex(message);\n    const payload = util_1.encodeRpcMessage(\"personal_sign\", [\n        hexMessage,\n        account.address,\n    ]);\n    const signature = await safeSend(payload, provider);\n    const signatureBytes = uint8arrays.fromString(signature.slice(2));\n    const digest = sha256.hash(signatureBytes);\n    return `0x${uint8arrays.toString(digest, 'base16')}`;\n}\nexports.authenticate = authenticate;\n//# sourceMappingURL=ethereum.js.map"]},"metadata":{},"sourceType":"script"}