{"ast":null,"code":"\"use strict\";\n\nvar _regeneratorRuntime = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\");\n\nvar _objectSpread = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/objectSpread2\");\n\nvar _classCallCheck = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar _inherits = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/inherits\");\n\nvar _createSuper = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createSuper\");\n\nvar _asyncToGenerator = require(\"C:/not-sync/git2/defiwiki-mono/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/asyncToGenerator\");\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function get() {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {\n    if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  }\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) {\n    if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  }\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nvar TileDocument_1;\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.TileDocument = void 0;\n\nvar fast_json_patch_1 = __importDefault(require(\"fast-json-patch\"));\n\nvar uint8arrays = __importStar(require(\"uint8arrays\"));\n\nvar random_1 = require(\"@stablelib/random\");\n\nvar common_1 = require(\"@ceramicnetwork/common\");\n\nvar streamid_1 = require(\"@ceramicnetwork/streamid\");\n\nvar DEFAULT_CREATE_OPTS = {\n  anchor: true,\n  publish: true,\n  sync: common_1.SyncOptions.PREFER_CACHE\n};\nvar DEFAULT_LOAD_OPTS = {\n  sync: common_1.SyncOptions.PREFER_CACHE\n};\nvar DEFAULT_UPDATE_OPTS = {\n  anchor: true,\n  publish: true\n};\n\nfunction headerFromMetadata(metadata) {\n  var _a;\n\n  if (typeof (metadata === null || metadata === void 0 ? void 0 : metadata.schema) === 'string') {\n    try {\n      streamid_1.CommitID.fromString(metadata.schema);\n    } catch (_b) {\n      throw new Error(\"Schema must be a CommitID\");\n    }\n  }\n\n  var header = {\n    controllers: metadata === null || metadata === void 0 ? void 0 : metadata.controllers,\n    family: metadata === null || metadata === void 0 ? void 0 : metadata.family,\n    schema: (_a = metadata === null || metadata === void 0 ? void 0 : metadata.schema) === null || _a === void 0 ? void 0 : _a.toString(),\n    tags: metadata === null || metadata === void 0 ? void 0 : metadata.tags\n  };\n  Object.keys(header).forEach(function (key) {\n    return header[key] === undefined && delete header[key];\n  });\n  return header;\n}\n\nfunction _ensureAuthenticated(_x) {\n  return _ensureAuthenticated2.apply(this, arguments);\n}\n\nfunction _ensureAuthenticated2() {\n  _ensureAuthenticated2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee8(signer) {\n    return _regeneratorRuntime.wrap(function _callee8$(_context8) {\n      while (1) {\n        switch (_context8.prev = _context8.next) {\n          case 0:\n            if (!(signer.did == null)) {\n              _context8.next = 2;\n              break;\n            }\n\n            throw new Error('No DID provided');\n\n          case 2:\n            if (signer.did.authenticated) {\n              _context8.next = 6;\n              break;\n            }\n\n            _context8.next = 5;\n            return signer.did.authenticate();\n\n          case 5:\n            if (signer.loggerProvider) {\n              signer.loggerProvider.getDiagnosticsLogger().imp(\"Now authenticated as DID \".concat(signer.did.id));\n            }\n\n          case 6:\n          case \"end\":\n            return _context8.stop();\n        }\n      }\n    }, _callee8);\n  }));\n  return _ensureAuthenticated2.apply(this, arguments);\n}\n\nfunction _signDagJWS(_x2, _x3, _x4) {\n  return _signDagJWS2.apply(this, arguments);\n}\n\nfunction _signDagJWS2() {\n  _signDagJWS2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee9(signer, commit, controller) {\n    return _regeneratorRuntime.wrap(function _callee9$(_context9) {\n      while (1) {\n        switch (_context9.prev = _context9.next) {\n          case 0:\n            _context9.next = 2;\n            return _ensureAuthenticated(signer);\n\n          case 2:\n            return _context9.abrupt(\"return\", signer.did.createDagJWS(commit, {\n              did: controller\n            }));\n\n          case 3:\n          case \"end\":\n            return _context9.stop();\n        }\n      }\n    }, _callee9);\n  }));\n  return _signDagJWS2.apply(this, arguments);\n}\n\nfunction throwReadOnlyError() {\n  return _throwReadOnlyError.apply(this, arguments);\n}\n\nfunction _throwReadOnlyError() {\n  _throwReadOnlyError = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee10() {\n    return _regeneratorRuntime.wrap(function _callee10$(_context10) {\n      while (1) {\n        switch (_context10.prev = _context10.next) {\n          case 0:\n            throw new Error('Historical stream commits cannot be modified. Load the stream without specifying a commit to make updates.');\n\n          case 1:\n          case \"end\":\n            return _context10.stop();\n        }\n      }\n    }, _callee10);\n  }));\n  return _throwReadOnlyError.apply(this, arguments);\n}\n\nvar TileDocument = TileDocument_1 = /*#__PURE__*/function (_common_1$Stream) {\n  _inherits(TileDocument, _common_1$Stream);\n\n  var _super = _createSuper(TileDocument);\n\n  function TileDocument() {\n    _classCallCheck(this, TileDocument);\n\n    return _super.apply(this, arguments);\n  }\n\n  _createClass(TileDocument, [{\n    key: \"content\",\n    get: function get() {\n      return this._getContent();\n    }\n  }, {\n    key: \"update\",\n    value: function () {\n      var _update = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(content, metadata) {\n        var opts,\n            updateCommit,\n            updated,\n            _args = arguments;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                opts = _args.length > 2 && _args[2] !== undefined ? _args[2] : {};\n                opts = _objectSpread(_objectSpread({}, DEFAULT_UPDATE_OPTS), opts);\n                _context.next = 4;\n                return this.makeCommit(this.api, content, metadata);\n\n              case 4:\n                updateCommit = _context.sent;\n                _context.next = 7;\n                return this.api.applyCommit(this.id, updateCommit, opts);\n\n              case 7:\n                updated = _context.sent;\n                this.state$.next(updated.state);\n\n              case 9:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function update(_x5, _x6) {\n        return _update.apply(this, arguments);\n      }\n\n      return update;\n    }()\n  }, {\n    key: \"patch\",\n    value: function () {\n      var _patch = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(jsonPatch) {\n        var opts,\n            header,\n            unsignedCommit,\n            commit,\n            updated,\n            _args2 = arguments;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                opts = _args2.length > 1 && _args2[1] !== undefined ? _args2[1] : {};\n                opts = _objectSpread(_objectSpread({}, DEFAULT_UPDATE_OPTS), opts);\n                header = headerFromMetadata(this.metadata);\n                unsignedCommit = {\n                  header: header,\n                  data: jsonPatch,\n                  prev: this.tip,\n                  id: this.state$.id.cid\n                };\n                _context2.next = 6;\n                return _signDagJWS(this.api, unsignedCommit, this.controllers[0]);\n\n              case 6:\n                commit = _context2.sent;\n                _context2.next = 9;\n                return this.api.applyCommit(this.id, commit, opts);\n\n              case 9:\n                updated = _context2.sent;\n                this.state$.next(updated.state);\n\n              case 11:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function patch(_x7) {\n        return _patch.apply(this, arguments);\n      }\n\n      return patch;\n    }()\n  }, {\n    key: \"makeReadOnly\",\n    value: function makeReadOnly() {\n      this.update = throwReadOnlyError;\n      this.patch = throwReadOnlyError;\n    }\n  }, {\n    key: \"makeCommit\",\n    value: function () {\n      var _makeCommit = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(signer, newContent, newMetadata) {\n        var _a, header, patch, commit;\n\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                header = headerFromMetadata(newMetadata);\n\n                if (newContent == null) {\n                  newContent = this.content;\n                }\n\n                if (!(header.controllers && ((_a = header.controllers) === null || _a === void 0 ? void 0 : _a.length) !== 1)) {\n                  _context3.next = 4;\n                  break;\n                }\n\n                throw new Error('Exactly one controller must be specified');\n\n              case 4:\n                patch = fast_json_patch_1.default.compare(this.content, newContent);\n                commit = {\n                  header: header,\n                  data: patch,\n                  prev: this.tip,\n                  id: this.state.log[0].cid\n                };\n                return _context3.abrupt(\"return\", _signDagJWS(signer, commit, this.controllers[0]));\n\n              case 7:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function makeCommit(_x8, _x9, _x10) {\n        return _makeCommit.apply(this, arguments);\n      }\n\n      return makeCommit;\n    }()\n  }], [{\n    key: \"create\",\n    value: function () {\n      var _create = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(ceramic, content, metadata) {\n        var opts,\n            commit,\n            _args4 = arguments;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                opts = _args4.length > 3 && _args4[3] !== undefined ? _args4[3] : {};\n                opts = _objectSpread(_objectSpread({}, DEFAULT_CREATE_OPTS), opts);\n\n                if (!(metadata === null || metadata === void 0 ? void 0 : metadata.deterministic) && opts.syncTimeoutSeconds == undefined) {\n                  opts.syncTimeoutSeconds = 0;\n                }\n\n                _context4.next = 5;\n                return TileDocument_1.makeGenesis(ceramic, content, metadata);\n\n              case 5:\n                commit = _context4.sent;\n                return _context4.abrupt(\"return\", ceramic.createStreamFromGenesis(TileDocument_1.STREAM_TYPE_ID, commit, opts));\n\n              case 7:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4);\n      }));\n\n      function create(_x11, _x12, _x13) {\n        return _create.apply(this, arguments);\n      }\n\n      return create;\n    }()\n  }, {\n    key: \"createFromGenesis\",\n    value: function () {\n      var _createFromGenesis = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(ceramic, genesisCommit) {\n        var opts,\n            _a,\n            commit,\n            _args5 = arguments;\n\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                opts = _args5.length > 2 && _args5[2] !== undefined ? _args5[2] : {};\n                opts = _objectSpread(_objectSpread({}, DEFAULT_CREATE_OPTS), opts);\n\n                if (((_a = genesisCommit.header) === null || _a === void 0 ? void 0 : _a.unique) && opts.syncTimeoutSeconds == undefined) {\n                  opts.syncTimeoutSeconds = 0;\n                }\n\n                if (!genesisCommit.data) {\n                  _context5.next = 9;\n                  break;\n                }\n\n                _context5.next = 6;\n                return _signDagJWS(ceramic, genesisCommit, genesisCommit.header.controllers[0]);\n\n              case 6:\n                _context5.t0 = _context5.sent;\n                _context5.next = 10;\n                break;\n\n              case 9:\n                _context5.t0 = genesisCommit;\n\n              case 10:\n                commit = _context5.t0;\n                return _context5.abrupt(\"return\", ceramic.createStreamFromGenesis(TileDocument_1.STREAM_TYPE_ID, commit, opts));\n\n              case 12:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5);\n      }));\n\n      function createFromGenesis(_x14, _x15) {\n        return _createFromGenesis.apply(this, arguments);\n      }\n\n      return createFromGenesis;\n    }()\n  }, {\n    key: \"load\",\n    value: function () {\n      var _load = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6(ceramic, streamId) {\n        var opts,\n            streamRef,\n            _args6 = arguments;\n        return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n          while (1) {\n            switch (_context6.prev = _context6.next) {\n              case 0:\n                opts = _args6.length > 2 && _args6[2] !== undefined ? _args6[2] : {};\n                opts = _objectSpread(_objectSpread({}, DEFAULT_LOAD_OPTS), opts);\n                streamRef = streamid_1.StreamRef.from(streamId);\n\n                if (!(streamRef.type != TileDocument_1.STREAM_TYPE_ID)) {\n                  _context6.next = 5;\n                  break;\n                }\n\n                throw new Error(\"StreamID \".concat(streamRef.toString(), \" does not refer to a '\").concat(TileDocument_1.STREAM_TYPE_NAME, \"' stream, but to a \").concat(streamRef.typeName));\n\n              case 5:\n                return _context6.abrupt(\"return\", ceramic.loadStream(streamRef, opts));\n\n              case 6:\n              case \"end\":\n                return _context6.stop();\n            }\n          }\n        }, _callee6);\n      }));\n\n      function load(_x16, _x17) {\n        return _load.apply(this, arguments);\n      }\n\n      return load;\n    }()\n  }, {\n    key: \"makeGenesis\",\n    value: function () {\n      var _makeGenesis = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee7(signer, content, metadata) {\n        var _a, header, commit;\n\n        return _regeneratorRuntime.wrap(function _callee7$(_context7) {\n          while (1) {\n            switch (_context7.prev = _context7.next) {\n              case 0:\n                if (!metadata) {\n                  metadata = {};\n                }\n\n                if (!(!metadata.controllers || metadata.controllers.length === 0)) {\n                  _context7.next = 9;\n                  break;\n                }\n\n                if (!signer.did) {\n                  _context7.next = 8;\n                  break;\n                }\n\n                _context7.next = 5;\n                return _ensureAuthenticated(signer);\n\n              case 5:\n                metadata.controllers = [signer.did.id];\n                _context7.next = 9;\n                break;\n\n              case 8:\n                throw new Error('No controllers specified');\n\n              case 9:\n                if (!(((_a = metadata.controllers) === null || _a === void 0 ? void 0 : _a.length) !== 1)) {\n                  _context7.next = 11;\n                  break;\n                }\n\n                throw new Error('Exactly one controller must be specified');\n\n              case 11:\n                header = headerFromMetadata(metadata);\n\n                if (metadata === null || metadata === void 0 ? void 0 : metadata.deterministic) {\n                  _context7.next = 16;\n                  break;\n                }\n\n                header.unique = uint8arrays.toString(random_1.randomBytes(12), 'base64');\n                _context7.next = 18;\n                break;\n\n              case 16:\n                if (!content) {\n                  _context7.next = 18;\n                  break;\n                }\n\n                throw new Error('Initial content must be null when creating a deterministic Tile document');\n\n              case 18:\n                if (!(content == null)) {\n                  _context7.next = 20;\n                  break;\n                }\n\n                return _context7.abrupt(\"return\", {\n                  header: header\n                });\n\n              case 20:\n                commit = {\n                  data: content,\n                  header: header\n                };\n                _context7.next = 23;\n                return _signDagJWS(signer, commit, metadata.controllers[0]);\n\n              case 23:\n                return _context7.abrupt(\"return\", _context7.sent);\n\n              case 24:\n              case \"end\":\n                return _context7.stop();\n            }\n          }\n        }, _callee7);\n      }));\n\n      function makeGenesis(_x18, _x19, _x20) {\n        return _makeGenesis.apply(this, arguments);\n      }\n\n      return makeGenesis;\n    }()\n  }]);\n\n  return TileDocument;\n}(common_1.Stream);\n\nTileDocument.STREAM_TYPE_NAME = 'tile';\nTileDocument.STREAM_TYPE_ID = 0;\nTileDocument = TileDocument_1 = __decorate([common_1.StreamStatic()], TileDocument);\nexports.TileDocument = TileDocument;","map":{"version":3,"sources":["../src/tile-document.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nvar TileDocument_1;\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.TileDocument = void 0;\nconst fast_json_patch_1 = __importDefault(require(\"fast-json-patch\"));\nconst uint8arrays = __importStar(require(\"uint8arrays\"));\nconst random_1 = require(\"@stablelib/random\");\nconst common_1 = require(\"@ceramicnetwork/common\");\nconst streamid_1 = require(\"@ceramicnetwork/streamid\");\nconst DEFAULT_CREATE_OPTS = { anchor: true, publish: true, sync: common_1.SyncOptions.PREFER_CACHE };\nconst DEFAULT_LOAD_OPTS = { sync: common_1.SyncOptions.PREFER_CACHE };\nconst DEFAULT_UPDATE_OPTS = { anchor: true, publish: true };\nfunction headerFromMetadata(metadata) {\n    var _a;\n    if (typeof (metadata === null || metadata === void 0 ? void 0 : metadata.schema) === 'string') {\n        try {\n            streamid_1.CommitID.fromString(metadata.schema);\n        }\n        catch (_b) {\n            throw new Error(\"Schema must be a CommitID\");\n        }\n    }\n    const header = {\n        controllers: metadata === null || metadata === void 0 ? void 0 : metadata.controllers,\n        family: metadata === null || metadata === void 0 ? void 0 : metadata.family,\n        schema: (_a = metadata === null || metadata === void 0 ? void 0 : metadata.schema) === null || _a === void 0 ? void 0 : _a.toString(),\n        tags: metadata === null || metadata === void 0 ? void 0 : metadata.tags,\n    };\n    Object.keys(header).forEach(key => header[key] === undefined && delete header[key]);\n    return header;\n}\nasync function _ensureAuthenticated(signer) {\n    if (signer.did == null) {\n        throw new Error('No DID provided');\n    }\n    if (!signer.did.authenticated) {\n        await signer.did.authenticate();\n        if (signer.loggerProvider) {\n            signer.loggerProvider.getDiagnosticsLogger().imp(`Now authenticated as DID ${signer.did.id}`);\n        }\n    }\n}\nasync function _signDagJWS(signer, commit, controller) {\n    await _ensureAuthenticated(signer);\n    return signer.did.createDagJWS(commit, { did: controller });\n}\nasync function throwReadOnlyError() {\n    throw new Error('Historical stream commits cannot be modified. Load the stream without specifying a commit to make updates.');\n}\nlet TileDocument = TileDocument_1 = class TileDocument extends common_1.Stream {\n    get content() {\n        return this._getContent();\n    }\n    static async create(ceramic, content, metadata, opts = {}) {\n        opts = { ...DEFAULT_CREATE_OPTS, ...opts };\n        if (!(metadata === null || metadata === void 0 ? void 0 : metadata.deterministic) && opts.syncTimeoutSeconds == undefined) {\n            opts.syncTimeoutSeconds = 0;\n        }\n        const commit = await TileDocument_1.makeGenesis(ceramic, content, metadata);\n        return ceramic.createStreamFromGenesis(TileDocument_1.STREAM_TYPE_ID, commit, opts);\n    }\n    static async createFromGenesis(ceramic, genesisCommit, opts = {}) {\n        var _a;\n        opts = { ...DEFAULT_CREATE_OPTS, ...opts };\n        if (((_a = genesisCommit.header) === null || _a === void 0 ? void 0 : _a.unique) && opts.syncTimeoutSeconds == undefined) {\n            opts.syncTimeoutSeconds = 0;\n        }\n        const commit = (genesisCommit.data ? await _signDagJWS(ceramic, genesisCommit, genesisCommit.header.controllers[0]) : genesisCommit);\n        return ceramic.createStreamFromGenesis(TileDocument_1.STREAM_TYPE_ID, commit, opts);\n    }\n    static async load(ceramic, streamId, opts = {}) {\n        opts = { ...DEFAULT_LOAD_OPTS, ...opts };\n        const streamRef = streamid_1.StreamRef.from(streamId);\n        if (streamRef.type != TileDocument_1.STREAM_TYPE_ID) {\n            throw new Error(`StreamID ${streamRef.toString()} does not refer to a '${TileDocument_1.STREAM_TYPE_NAME}' stream, but to a ${streamRef.typeName}`);\n        }\n        return ceramic.loadStream(streamRef, opts);\n    }\n    async update(content, metadata, opts = {}) {\n        opts = { ...DEFAULT_UPDATE_OPTS, ...opts };\n        const updateCommit = await this.makeCommit(this.api, content, metadata);\n        const updated = await this.api.applyCommit(this.id, updateCommit, opts);\n        this.state$.next(updated.state);\n    }\n    async patch(jsonPatch, opts = {}) {\n        opts = { ...DEFAULT_UPDATE_OPTS, ...opts };\n        const header = headerFromMetadata(this.metadata);\n        const unsignedCommit = { header, data: jsonPatch, prev: this.tip, id: this.state$.id.cid };\n        const commit = await _signDagJWS(this.api, unsignedCommit, this.controllers[0]);\n        const updated = await this.api.applyCommit(this.id, commit, opts);\n        this.state$.next(updated.state);\n    }\n    makeReadOnly() {\n        this.update = throwReadOnlyError;\n        this.patch = throwReadOnlyError;\n    }\n    async makeCommit(signer, newContent, newMetadata) {\n        var _a;\n        const header = headerFromMetadata(newMetadata);\n        if (newContent == null) {\n            newContent = this.content;\n        }\n        if (header.controllers && ((_a = header.controllers) === null || _a === void 0 ? void 0 : _a.length) !== 1) {\n            throw new Error('Exactly one controller must be specified');\n        }\n        const patch = fast_json_patch_1.default.compare(this.content, newContent);\n        const commit = { header, data: patch, prev: this.tip, id: this.state.log[0].cid };\n        return _signDagJWS(signer, commit, this.controllers[0]);\n    }\n    static async makeGenesis(signer, content, metadata) {\n        var _a;\n        if (!metadata) {\n            metadata = {};\n        }\n        if (!metadata.controllers || metadata.controllers.length === 0) {\n            if (signer.did) {\n                await _ensureAuthenticated(signer);\n                metadata.controllers = [signer.did.id];\n            }\n            else {\n                throw new Error('No controllers specified');\n            }\n        }\n        if (((_a = metadata.controllers) === null || _a === void 0 ? void 0 : _a.length) !== 1) {\n            throw new Error('Exactly one controller must be specified');\n        }\n        const header = headerFromMetadata(metadata);\n        if (!(metadata === null || metadata === void 0 ? void 0 : metadata.deterministic)) {\n            header.unique = uint8arrays.toString(random_1.randomBytes(12), 'base64');\n        }\n        else if (content) {\n            throw new Error('Initial content must be null when creating a deterministic Tile document');\n        }\n        if (content == null) {\n            return { header };\n        }\n        const commit = { data: content, header };\n        return await _signDagJWS(signer, commit, metadata.controllers[0]);\n    }\n};\nTileDocument.STREAM_TYPE_NAME = 'tile';\nTileDocument.STREAM_TYPE_ID = 0;\nTileDocument = TileDocument_1 = __decorate([\n    common_1.StreamStatic()\n], TileDocument);\nexports.TileDocument = TileDocument;\n//# sourceMappingURL=tile-document.js.map"]},"metadata":{},"sourceType":"script"}